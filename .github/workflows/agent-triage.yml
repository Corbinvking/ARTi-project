name: "Agent Triage: Auto-label & Route Issues"

# =============================================================================
# Automatically parses new issues from templates, applies the correct app:*
# label, and sets priority/complexity labels based on form responses.
# This is the ENTRY POINT of the agentic pipeline.
# =============================================================================

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue and apply labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const labels = [];

            // ---------------------------------------------------------------
            // 1. Detect app domain from issue template dropdown
            // ---------------------------------------------------------------
            const appMap = {
              'Spotify':        'app:spotify',
              'Instagram':      'app:instagram',
              'YouTube':        'app:youtube',
              'SoundCloud':     'app:soundcloud',
              'Dashboard':      'app:dashboard',
              'Operator':       'app:operator',
              'Admin':          'app:admin',
              'API / Backend':  'app:api',
              'API':            'app:api',
              'Scraper':        'app:scraper',
              'Shared':         'app:shared',
              'Infrastructure': 'app:infra',
              'Database':       'app:database',
            };

            for (const [keyword, label] of Object.entries(appMap)) {
              if (body.includes(keyword)) {
                labels.push(label);
                break;
              }
            }

            // ---------------------------------------------------------------
            // 2. Detect severity â†’ priority mapping
            // ---------------------------------------------------------------
            if (body.includes('Critical - Production broken')) {
              labels.push('priority:critical');
            } else if (body.includes('High - Major feature broken')) {
              labels.push('priority:high');
            } else if (body.includes('Medium - Feature degraded')) {
              labels.push('priority:medium');
            } else if (body.includes('Low - Minor cosmetic issue')) {
              labels.push('priority:low');
            }

            // ---------------------------------------------------------------
            // 3. Detect complexity
            // ---------------------------------------------------------------
            if (body.includes('Low - Simple, isolated change')) {
              labels.push('complexity:low');
            } else if (body.includes('Medium - Moderate scope')) {
              labels.push('complexity:medium');
            } else if (body.includes('High - Complex, architectural')) {
              labels.push('complexity:high');
            }

            // ---------------------------------------------------------------
            // 4. Detect agent assignability
            // ---------------------------------------------------------------
            if (body.includes('Yes - Well-scoped') || body.includes('Yes - Well-defined')) {
              labels.push('agent:ready');
            } else if (body.includes('Yes - Clear refactoring scope')) {
              labels.push('agent:ready');
            }

            // ---------------------------------------------------------------
            // 5. Apply labels
            // ---------------------------------------------------------------
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels,
              });

              console.log(`Applied labels to issue #${issue.number}: ${labels.join(', ')}`);
            }

            // ---------------------------------------------------------------
            // 6. Add triage summary comment
            // ---------------------------------------------------------------
            const appLabel = labels.find(l => l.startsWith('app:')) || 'unknown';
            const isAgentReady = labels.includes('agent:ready');

            let comment = `### ðŸ” Auto-Triage Summary\n\n`;
            comment += `| Field | Value |\n|-------|-------|\n`;
            comment += `| **App Domain** | \`${appLabel}\` |\n`;
            comment += `| **Labels Applied** | ${labels.map(l => '`' + l + '`').join(', ')} |\n`;
            comment += `| **Agent Eligible** | ${isAgentReady ? 'âœ… Yes â€” will be dispatched when an agent picks it up' : 'â³ Needs manual triage'} |\n`;
            comment += `\n---\n`;

            if (isAgentReady) {
              comment += `> This issue has been marked as agent-assignable. `;
              comment += `The **Agent Dispatcher** workflow will pick it up and create a working branch.\n`;
              comment += `> To prevent agent assignment, remove the \`agent:ready\` label.`;
            } else {
              comment += `> To assign this to an agent, add the \`agent:ready\` label after review.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment,
            });
